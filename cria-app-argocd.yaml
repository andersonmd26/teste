apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: create-repo-and-argocd
  title: Criar repo + ArgoCD Application
  description: Cria repositório e application no Argo CD
spec:
  owner: user:anderson
  type: service

  parameters:
    - title: Informações do Projeto
      required:
        - nome
      properties:
        nome:
          type: string
          title: Nome do app

  steps:
    - id: criar-repo
      name: Criar repositório
      action: publish:github
      input:
        repoUrl: github.com/sua-org/${{ parameters.nome }}
        defaultBranch: main
        description: Projeto criado via Backstage

    - id: criar-application-argocd
      name: Criar Application no ArgoCD
      action: fetch:plain
      input:
        url: https://argocd.suaempresa.com/api/v1/applications
        method: POST
        headers:
          Authorization: Bearer ${{ secrets.ARGOCD_AUTH_TOKEN }}
          Content-Type: application/json
        body: |
          {
            "metadata": {
              "name": "${{ parameters.nome }}",
              "namespace": "argocd"
            },
            "spec": {
              "project": "default",
              "source": {
                "repoURL": "https://github.com/sua-org/${{ parameters.nome }}.git",
                "targetRevision": "HEAD",
                "path": "manifests"
              },
              "destination": {
                "server": "https://kubernetes.default.svc",
                "namespace": "${{ parameters.nome }}"
              },
              "syncPolicy": {
                "automated": {
                  "prune": true,
                  "selfHeal": true
                },
                "syncOptions": [
                  "CreateNamespace=true"
                ]
              }
            }
          }

    - id: registrar-no-catalogo
      name: Registrar no catálogo
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['criar-repo'].output.repoContentsUrl }}
        catalogInfoPath: /catalog-info.yaml

  output:
    links:
      - title: Repositório criado
        url: ${{ steps['criar-repo'].output.remoteUrl }}
